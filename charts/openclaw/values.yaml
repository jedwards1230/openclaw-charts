# -- Override the chart name
nameOverride: ""
# -- Override the full release name
fullnameOverride: ""

image:
  repository: ghcr.io/jedwards1230/openclaw-charts
  tag: latest
  pullPolicy: IfNotPresent

imagePullSecrets: []

replicaCount: 1

strategy:
  type: Recreate

# -- OpenClaw gateway configuration (templated into openclaw.json)
gateway:
  port: 18789
  bind: "lan"
  auth:
    mode: "token"
    # -- Allow Tailscale identity-header authentication (tailscale whois)
    allowTailscale: false
  controlUi:
    # -- Allow non-HTTPS auth for control UI. Set to true only for local development without TLS.
    allowInsecureAuth: false

# -- Freeform app config (merged with gateway into openclaw.json)
# Add any top-level openclaw.json keys here (agents, channels, tools, etc.)
# These are serialized to JSON as-is — no chart update needed for config changes.
config: {}

# -- Hook transform files to mount at /home/node/.openclaw/hooks/transforms
# Map of filename -> file content. When set, creates a ConfigMap and mounts it read-only.
# Example:
#   hookTransforms:
#     github.js: |
#       export default function transform(event) {
#         // Transform GitHub webhook payload
#         return event;
#       }
hookTransforms: {}

# -- Agent utility scripts to mount at ~/.openclaw/scripts (available to all workspaces/agents)
# Map of filename -> file content. When set, creates a ConfigMap and mounts it read-only.
# Scripts are mounted read-only but remain executable (ConfigMap default mode 0644, which is readable/executable for directories).
# Example:
#   agentScripts:
#     sync-repo.sh: |
#       #!/bin/bash
#       # Fetch and sync a git repository
#       cd "$1" && git fetch origin && git pull
agentScripts: {}

# -- Extra environment variables for the main container
# Use this to inject secrets, API keys, or any additional env vars.
# Example:
#   extraEnv:
#     - name: MY_SECRET
#       valueFrom:
#         secretKeyRef:
#           name: my-secret
#           key: MY_KEY
extraEnv: []

# -- Extra environment variables from secrets/configmaps (bulk injection)
# Example:
#   extraEnvFrom:
#     - secretRef:
#         name: my-secret
#     - configMapRef:
#         name: my-config
extraEnvFrom: []

# -- Git identity for commits
git:
  authorName: "LilClaw"
  authorEmail: "lilclaw@lilbro.cloud"
  committerName: "LilClaw"
  committerEmail: "lilclaw@lilbro.cloud"
  configGlobal: "/home/node/.openclaw/.gitconfig"

# -- Node.js options
nodeOptions: "--max-old-space-size=1536"

# -- Home directory path inside the container
homePath: "/home/node"

# -- Envsubst init container image (runs as non-root, must include envsubst binary)
# Pin to a versioned tag or digest — avoid :latest for supply-chain safety.
envsubst:
  image: dibi/envsubst:1

# -- Secrets configuration
secrets:
  existingSecret: ""
  onepassword:
    enabled: false
    itemPath: ""

# -- NFS persistence for openclaw workspace/config
persistence:
  size: 10Gi
  accessModes:
    - ReadWriteMany
  nfs:
    enabled: false
    server: ""
    path: ""

# -- Claude Code persistence for ~/.claude directory
# Separates Claude's session data from the main NFS share for cleaner isolation.
# Uses Longhorn (or cluster default storage class) for pod-local persistence.
claudeCode:
  persistence:
    # -- Enable dedicated PVC for ~/.claude
    enabled: true
    # -- Storage size for Claude Code data
    size: 1Gi
    # -- Storage class name (empty string uses cluster default, typically "longhorn")
    storageClassName: ""

# -- Ingress configuration
ingress:
  enabled: false
  host: ""
  annotations: {}
  tls: []

# -- Additional ingresses for separate access rules
# Useful for exposing specific endpoints (e.g., webhooks) with different
# security settings while keeping the main UI restricted to LAN-only access.
#
# Example: Expose /hooks endpoint publicly while main UI stays LAN-only
# additionalIngresses:
#   - name: webhook
#     enabled: true
#     host: openclaw.example.com
#     path: /hooks
#     pathType: Prefix
#     annotations:
#       traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
#       cert-manager.io/cluster-issuer: letsencrypt-prod
#     tls:
#       - hosts:
#           - openclaw.example.com
#         secretName: openclaw-webhook-tls
additionalIngresses: []

# -- Service configuration
service:
  type: ClusterIP
  port: 18789
  # -- Target port on the container (defaults to gateway.port if not set)
  targetPort: ""

# -- ServiceAccount configuration
serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# -- Resource requests and limits
resources:
  requests:
    cpu: 100m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# -- Pod security context
podSecurityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  runAsNonRoot: true
  seccompProfile:
    type: RuntimeDefault

# -- Container security context
securityContext:
  allowPrivilegeEscalation: false
  # Writable paths (/tmp, ~/.cache, ~/.npm) are provided via emptyDir mounts.
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  capabilities:
    drop:
      - ALL
  # Chromium (v112+) uses syscalls (clone3, io_uring, userfaultfd) not permitted
  # by the RuntimeDefault seccomp profile applied at the pod level. Without Unconfined,
  # Chromium 145 crashes on startup with SIGTRAP (SECCOMP_RET_TRAP) from the kernel.
  # Other security controls remain active: non-root user (uid 1000), read-only rootfs,
  # all Linux capabilities dropped, allowPrivilegeEscalation=false.
  # This only affects the openclaw container — sidecar containers (tailscale, webhookd)
  # still inherit RuntimeDefault from podSecurityContext.
  seccompProfile:
    type: Unconfined

# -- Pod annotations (e.g., Velero backup hooks)
podAnnotations: {}

# -- Priority class name for scheduling priority
priorityClassName: ""

# -- Override default health probes (TCP socket on gateway port)
# Set per-probe config to override. Omit or set to {} to use defaults.
probes:
  startup: {}
  liveness: {}
  readiness: {}

# -- Webhookd sidecar: GitHub webhook signature verification proxy
# Receives GitHub webhook POSTs, verifies X-Hub-Signature-256 HMAC,
# and forwards to openclaw's /hooks/agent endpoint using the x-openclaw-token header.
webhookd:
  enabled: false
  image:
    repository: node
    tag: "22-alpine"
    pullPolicy: IfNotPresent
  port: 8090
  # -- Target path on openclaw gateway to forward verified webhooks to
  targetPath: "/hooks/agent"
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 64Mi

# -- Tailscale sidecar: expose the gateway on your tailnet
# When enabled, a Tailscale sidecar container runs alongside OpenClaw,
# providing a tailnet hostname via `tailscale serve`. The OpenClaw container
# stays on LAN binding so Traefik ingress continues working.
tailscale:
  enabled: false
  # -- Existing secret containing the Tailscale auth key
  authKeySecret: ""
  # -- Key within the secret that holds the auth key value
  authKeySecretKey: "TS_AUTHKEY"
  # -- Hostname on the tailnet (e.g., "openclaw")
  hostname: ""
  # -- Tailscale image
  image:
    repository: ghcr.io/tailscale/tailscale
    tag: "v1.82.5"
    pullPolicy: IfNotPresent
  # -- Sidecar resource limits
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 128Mi

# -- Additional pod labels
# Note: Pod Security Admission (PSA) labels (pod-security.kubernetes.io/*)
# must be applied to the Namespace, not individual Pods. Configure them on
# the namespace outside this chart if needed.
podLabels: {}

# -- Network policy configuration
# When enabled, applies a NetworkPolicy that:
# - Allows inbound traffic from Traefik ingress and from any pod in the same namespace
# - Allows outbound DNS (UDP/53), HTTP (TCP/80), HTTPS (TCP/443)
# - Conditionally allows egress via toggles:
#   allowMcpProxy  - mcp-proxy pods in same namespace (TCP/8080)
#   allowOllama    - Ollama LLM service (TCP/11434)
#   allowOtel      - OTEL collector in monitoring namespace (TCP/4317, TCP/4318)
networkPolicy:
  enabled: false
  # -- Allow egress to mcp-proxy pods in the same namespace (TCP/8080).
  # Only enable for gateways that need MCP tool access.
  allowMcpProxy: false
  # -- Allow egress to Ollama LLM service (TCP/11434).
  allowOllama: false
  # -- Allow egress to OTEL collector in the monitoring namespace (TCP/4317 gRPC, TCP/4318 HTTP).
  allowOtel: false

# -- Extra volume mounts for the main container
# Example:
#   extraVolumeMounts:
#     - name: dev-workspace
#       mountPath: /mnt/dev
extraVolumeMounts: []

# -- Extra volumes for the pod
# Example:
#   extraVolumes:
#     - name: dev-workspace
#       persistentVolumeClaim:
#         claimName: openclaw-dev-workspace
extraVolumes: []

# -- Extra init containers (in addition to the built-in envsubst and tailscale-init)
# Example:
#   extraInitContainers:
#     - name: wait-for-db
#       image: busybox:1.36
#       command: ["sh", "-c", "until nc -z db 5432; do sleep 2; done"]
extraInitContainers: []

# -- Extra sidecar containers (in addition to the built-in tailscale and webhookd)
# Example:
#   extraContainers:
#     - name: log-forwarder
#       image: fluent/fluent-bit:3.2
extraContainers: []

nodeSelector:
  kubernetes.io/arch: amd64
tolerations: []
affinity: {}
topologySpreadConstraints: []

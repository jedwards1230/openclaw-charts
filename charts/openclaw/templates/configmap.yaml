apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "openclaw.fullname" . }}-config
  labels:
    {{- include "openclaw.labels" . | nindent 4 }}
data:
  {{- $gatewayAuth := dict "mode" .Values.gateway.auth.mode "token" "${GATEWAY_AUTH_TOKEN}" }}
  {{- if .Values.gateway.auth.allowTailscale }}
  {{- $_ := set $gatewayAuth "allowTailscale" true }}
  {{- end }}
  {{- if .Values.gateway.auth.rateLimit }}
  {{- $_ := set $gatewayAuth "rateLimit" .Values.gateway.auth.rateLimit }}
  {{- end }}
  {{- $gatewayControlUi := dict "allowInsecureAuth" .Values.gateway.controlUi.allowInsecureAuth }}
  {{- if .Values.gateway.controlUi.dangerouslyDisableDeviceAuth }}
  {{- $_ := set $gatewayControlUi "dangerouslyDisableDeviceAuth" true }}
  {{- end }}
  {{- $gateway := dict "bind" .Values.gateway.bind "port" (int64 .Values.gateway.port) "auth" $gatewayAuth "controlUi" $gatewayControlUi }}
  {{- if .Values.gateway.trustedProxies }}
  {{- $_ := set $gateway "trustedProxies" .Values.gateway.trustedProxies }}
  {{- end }}
  {{- if .Values.gateway.customBindHost }}
  {{- $_ := set $gateway "customBindHost" .Values.gateway.customBindHost }}
  {{- end }}
  {{- /* Build config, appending pluginRepos paths to config.plugins.load.paths */}}
  {{- $config := deepCopy (.Values.config | default dict) }}
  {{- if .Values.pluginRepos }}
  {{- $plugins := $config.plugins | default dict }}
  {{- $load := $plugins.load | default dict }}
  {{- $existingPaths := $load.paths | default list }}
  {{- $repoPaths := list }}
  {{- $seenNames := dict }}
  {{- range .Values.pluginRepos }}
  {{- /* Validate name: required, no path separators */}}
  {{- if not .name }}{{ fail "pluginRepos: name is required for each entry" }}{{- end }}
  {{- if or (contains "/" .name) (contains "\\" .name) }}{{ fail (printf "pluginRepos: name %q must not contain path separators" .name) }}{{- end }}
  {{- if hasKey $seenNames .name }}{{ fail (printf "pluginRepos: duplicate name %q â€” each entry must have a unique name" .name) }}{{- end }}
  {{- $_ := set $seenNames .name true }}
  {{- /* Validate subdir: no leading slash, no path traversal */}}
  {{- if .subdir }}
  {{- if or (hasPrefix "/" .subdir) (contains ".." .subdir) }}{{ fail (printf "pluginRepos: subdir %q for %q must not start with '/' or contain '..'" .subdir .name) }}{{- end }}
  {{- end }}
  {{- $mountPath := printf "/plugins/%s" .name }}
  {{- if .subdir }}
  {{- $mountPath = printf "/plugins/%s/%s" .name .subdir }}
  {{- end }}
  {{- $repoPaths = append $repoPaths $mountPath }}
  {{- end }}
  {{- $_ := set $load "paths" (concat $existingPaths $repoPaths) }}
  {{- $_ = set $plugins "load" $load }}
  {{- $_ = set $config "plugins" $plugins }}
  {{- end }}
  {{- $merged := merge (dict "gateway" $gateway) $config }}
  openclaw.json: |
{{ mustToPrettyJson $merged | indent 4 }}

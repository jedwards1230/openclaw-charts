name: Release

on:
  push:
    branches: [main]
    paths:
      - "Dockerfile"
      - "charts/**"
  schedule:
    - cron: "0 2 * * *" # Daily at 02:00 UTC
  workflow_dispatch:

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  packages: write

jobs:
  docker-release:
    name: Docker Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Get OpenClaw version
        id: versions
        run: |
          VERSION=$(grep '^ARG OPENCLAW_VERSION=' Dockerfile | cut -d= -f2)
          if [ -z "$VERSION" ]; then
            echo "::error::Could not find ARG OPENCLAW_VERSION in Dockerfile"
            exit 1
          fi
          echo "openclaw_version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=docker-${VERSION}" >> "$GITHUB_OUTPUT"
          echo "OpenClaw version: ${VERSION}"

      - name: Check if release exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "${{ steps.versions.outputs.tag }}" &>/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release ${{ steps.versions.outputs.tag }} already exists — skipping"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Release ${{ steps.versions.outputs.tag }} not found — will create"
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: steps.check.outputs.exists == 'false'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        if: steps.check.outputs.exists == 'false'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.versions.outputs.openclaw_version }}
          labels: |
            org.opencontainers.image.version=${{ steps.versions.outputs.openclaw_version }}
          build-args: |
            OPENCLAW_VERSION=${{ steps.versions.outputs.openclaw_version }}
          cache-from: type=gha,scope=openclaw
          cache-to: type=gha,mode=max,scope=openclaw
          provenance: true

      - name: Create GitHub Release
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.versions.outputs.openclaw_version }}"
          TAG="${{ steps.versions.outputs.tag }}"
          gh release create "${TAG}" \
            --title "Docker Image ${VERSION}" \
            --notes "Docker image built on OpenClaw ${VERSION} (https://github.com/openclaw/openclaw/releases/tag/${VERSION}). Pull: docker pull ghcr.io/${{ github.repository }}:${VERSION}" \
            --target "${{ github.sha }}"

  helm-release:
    name: Helm Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Get chart versions
        id: versions
        run: |
          CHART_VERSION=$(grep '^version:' charts/openclaw/Chart.yaml | awk '{print $2}')
          APP_VERSION=$(grep '^appVersion:' charts/openclaw/Chart.yaml | awk '{print $2}' | tr -d '"')
          if [ -z "$CHART_VERSION" ] || [ -z "$APP_VERSION" ]; then
            echo "::error::Could not read chart version or app version from Chart.yaml"
            exit 1
          fi
          echo "chart_version=${CHART_VERSION}" >> "$GITHUB_OUTPUT"
          echo "app_version=${APP_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=openclaw-${CHART_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Chart version: ${CHART_VERSION}, App version: ${APP_VERSION}"

      - name: Check if release exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "${{ steps.versions.outputs.tag }}" &>/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release ${{ steps.versions.outputs.tag }} already exists — skipping"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Release ${{ steps.versions.outputs.tag }} not found — will create"
          fi

      - name: Set up Helm
        if: steps.check.outputs.exists == 'false'
        uses: azure/setup-helm@v4

      - name: Login to GHCR
        if: steps.check.outputs.exists == 'false'
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Package and push Helm chart
        if: steps.check.outputs.exists == 'false'
        run: |
          helm package charts/openclaw/
          helm push openclaw-*.tgz oci://ghcr.io/${{ github.repository_owner }}/charts

      - name: Create GitHub Release
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHART_VERSION="${{ steps.versions.outputs.chart_version }}"
          APP_VERSION="${{ steps.versions.outputs.app_version }}"
          TAG="${{ steps.versions.outputs.tag }}"
          gh release create "${TAG}" \
            --title "Helm Chart openclaw-${CHART_VERSION}" \
            --notes "Helm chart openclaw version ${CHART_VERSION} for OpenClaw ${APP_VERSION}. Install: helm install openclaw oci://ghcr.io/${{ github.repository_owner }}/charts/openclaw --version ${CHART_VERSION}" \
            --target "${{ github.sha }}"

# Checks for new upstream openclaw releases every 6 hours.
# Creates or updates a version-bump PR, posts per-version release notes,
# and triggers Claude upgrade analysis.
# Supports version stacking: if multiple releases drop before merge,
# each gets its own release-notes comment and Claude analysis on the same PR.
# Uses a stable branch name (auto/bump-openclaw) so the PR persists across versions.

name: Check Upstream Release
run-name: "Check upstream release${{ github.event_name == 'workflow_dispatch' && ' (manual)' || '' }}"

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours (4x daily)
  workflow_dispatch:

concurrency:
  group: check-upstream
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  actions: write

env:
  UPSTREAM_REPO: openclaw/openclaw
  BUMP_BRANCH: auto/bump-openclaw

jobs:
  check:
    name: Check for New Release
    runs-on: ubuntu-latest
    outputs:
      needs_update: ${{ steps.compare.outputs.needs_update }}
      pr_number: ${{ steps.pr.outputs.number }}
      origin_version: ${{ steps.pr.outputs.origin_version }}
      tag: ${{ steps.upstream.outputs.tag }}
      already_bumped: ${{ steps.check_branch.outputs.already_bumped }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get current version
        id: current
        run: |
          VERSION=$(grep '^appVersion:' charts/openclaw/Chart.yaml \
            | awk '{print $2}' | tr -d '"')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Current appVersion: $VERSION"

      - name: Get latest upstream release
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Try authenticated first, fall back to unauthenticated curl
          RELEASE_JSON=$(gh api "repos/${{ env.UPSTREAM_REPO }}/releases/latest" 2>/dev/null \
            || curl -sf "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest" \
            || true)
          if [ -z "$RELEASE_JSON" ] || echo "$RELEASE_JSON" | jq -e 'has("message")' >/dev/null 2>&1; then
            echo "Failed to fetch upstream release — skipping"
            echo "tag=" >> "$GITHUB_OUTPUT"
            echo "version=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          TAG=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          # Strip leading 'v'
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Latest upstream: $TAG ($VERSION)"

      - name: Compare versions
        id: compare
        run: |
          UPSTREAM_VERSION="${{ steps.upstream.outputs.version }}"
          if [ -z "$UPSTREAM_VERSION" ]; then
            echo "Upstream version unavailable — skipping"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          elif [ "${{ steps.current.outputs.version }}" = "$UPSTREAM_VERSION" ]; then
            echo "Up to date — nothing to do"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          else
            echo "New version available: ${{ steps.current.outputs.version }} → $UPSTREAM_VERSION"
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if branch already bumped to this version
        if: steps.compare.outputs.needs_update == 'true'
        id: check_branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.upstream.outputs.tag }}
          VERSION: ${{ steps.upstream.outputs.version }}
        run: |
          set -euo pipefail

          # Check if the bump branch exists and already has this version
          if git ls-remote --exit-code origin "refs/heads/${{ env.BUMP_BRANCH }}" >/dev/null 2>&1; then
            git fetch origin "${{ env.BUMP_BRANCH }}"
            BRANCH_VERSION=$(git show "origin/${{ env.BUMP_BRANCH }}:charts/openclaw/Chart.yaml" \
              | grep '^appVersion:' | awk '{print $2}' | tr -d '"')
            if [ "$BRANCH_VERSION" = "$VERSION" ]; then
              echo "Branch already bumped to ${VERSION} — skipping push"
              echo "already_bumped=true" >> "$GITHUB_OUTPUT"
            else
              echo "Branch exists at ${BRANCH_VERSION}, will update to ${VERSION}"
              echo "already_bumped=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "Branch does not exist — will create"
            echo "already_bumped=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump and push branch
        if: steps.compare.outputs.needs_update == 'true' && steps.check_branch.outputs.already_bumped != 'true'
        env:
          TAG: ${{ steps.upstream.outputs.tag }}
          VERSION: ${{ steps.upstream.outputs.version }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git checkout -B "${{ env.BUMP_BRANCH }}" origin/main
          ./scripts/bump-version.sh "$VERSION" --bump-chart
          git add -A
          git commit -m "chore: bump openclaw to ${TAG}

          Upstream release: https://github.com/${{ env.UPSTREAM_REPO }}/releases/tag/${TAG}

          Co-authored-by: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          git push --force origin "${{ env.BUMP_BRANCH }}"

      - name: Create or update PR
        if: steps.compare.outputs.needs_update == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT: ${{ steps.current.outputs.version }}
          TAG: ${{ steps.upstream.outputs.tag }}
        run: |
          set -euo pipefail

          # ── Clean up old version-specific branches (legacy) ─────
          git fetch origin --prune
          for remote_branch in $(git branch -r | grep 'origin/auto/bump-openclaw-v' | sed 's|origin/||'); do
            LEGACY_PR=$(gh pr list --head "$remote_branch" --state open --json number --jq '.[0].number // empty' 2>/dev/null || true)
            if [ -n "$LEGACY_PR" ]; then
              gh pr close "$LEGACY_PR" --comment "Migrated to stable branch: ${{ env.BUMP_BRANCH }}" --delete-branch 2>/dev/null || true
            else
              git push origin --delete "$remote_branch" 2>/dev/null || true
            fi
          done

          # ── Determine origin version ────────────────────────────
          EXISTING_PR=$(gh pr list --head "${{ env.BUMP_BRANCH }}" --state open \
            --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING_PR" ]; then
            # Extract origin version from existing PR description
            PR_BODY_TEXT=$(gh pr view "$EXISTING_PR" --json body --jq '.body')
            ORIGIN_VERSION=$(echo "$PR_BODY_TEXT" | grep -oP '(?<=\*\*Origin\*\*: `v)[^`]+' || echo "$CURRENT")
          else
            ORIGIN_VERSION="$CURRENT"
          fi

          echo "origin_version=$ORIGIN_VERSION" >> "$GITHUB_OUTPUT"

          PR_BODY="## Summary

          Automated version bump from upstream release.

          - **Origin**: \`v${ORIGIN_VERSION}\`
          - **Latest**: \`${TAG}\`
          - **Release**: https://github.com/${{ env.UPSTREAM_REPO }}/releases/tag/${TAG}

          > Created automatically by the [check-upstream](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow."

          # ── Create or update PR ──────────────────────────────────
          if [ -n "$EXISTING_PR" ]; then
            echo "Updating existing PR #${EXISTING_PR}"
            gh pr edit "$EXISTING_PR" \
              --title "chore: bump openclaw v${ORIGIN_VERSION} → ${TAG}" \
              --body "$PR_BODY"
            echo "number=$EXISTING_PR" >> "$GITHUB_OUTPUT"
          else
            gh pr create \
              --title "chore: bump openclaw to ${TAG}" \
              --body "$PR_BODY" \
              --head "${{ env.BUMP_BRANCH }}" \
              --base main
            PR_NUMBER=$(gh pr list --head "${{ env.BUMP_BRANCH }}" --state open \
              --json number --jq '.[0].number')
            echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          fi

      - name: Post release notes comment
        if: steps.compare.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.upstream.outputs.tag }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          set -euo pipefail

          RELEASE_NOTES=$(gh api "repos/${{ env.UPSTREAM_REPO }}/releases/tags/${TAG}" \
            --jq '.body // empty' 2>/dev/null || true)

          if [ -n "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="${RELEASE_NOTES:0:10000}"
            COMMENT="### Release Notes for ${TAG}

          ${RELEASE_NOTES}"
            # Only post once — prevent duplicate comments on retry
            ALREADY_COMMENTED=$(gh api --paginate "repos/${GITHUB_REPOSITORY}/issues/${PR_NUMBER}/comments" \
              | jq --arg v "### Release Notes for ${TAG}" '[.[] | select(.body | contains($v))] | length' \
              | awk '{s+=$1} END{print s}')
            if [ "$ALREADY_COMMENTED" = "0" ]; then
              gh pr comment "$PR_NUMBER" --body "$COMMENT"
            fi
          fi

      - name: Summary
        if: always()
        env:
          NEEDS_UPDATE: ${{ steps.compare.outputs.needs_update }}
          CURRENT: ${{ steps.current.outputs.version }}
          TAG: ${{ steps.upstream.outputs.tag }}
          ALREADY_BUMPED: ${{ steps.check_branch.outputs.already_bumped }}
        run: |
          if [ "$NEEDS_UPDATE" = "true" ] && [ "$ALREADY_BUMPED" = "true" ]; then
            echo "### :white_check_mark: openclaw: PR already exists for ${TAG}" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$NEEDS_UPDATE" = "true" ]; then
            echo "### :arrow_up: openclaw: v${CURRENT} → ${TAG}" >> "$GITHUB_STEP_SUMMARY"
          elif [ "$NEEDS_UPDATE" = "false" ]; then
            echo "### :white_check_mark: openclaw: up to date (v${CURRENT})" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### :warning: openclaw: update check did not complete" >> "$GITHUB_STEP_SUMMARY"
          fi

  analyze:
    name: Claude Upgrade Analysis
    needs: check
    if: needs.check.outputs.needs_update == 'true' && needs.check.outputs.pr_number != ''
    uses: ./.github/workflows/claude-upgrade-analysis.yml
    with:
      pr_number: ${{ needs.check.outputs.pr_number }}
      origin_version: ${{ needs.check.outputs.origin_version }}
      new_tag: ${{ needs.check.outputs.tag }}
    secrets:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
